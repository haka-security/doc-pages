


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>9. Rules &mdash; Haka runtime 0.3.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/haka.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/breathe.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/scripts.js"></script>
    <script type="text/javascript" src="../../_static/js/vendor/modernizr.js"></script>
    <script type="text/javascript" src="../../_static/js/foundation/foundation.js"></script>
    <script type="text/javascript" src="../../_static/js/foundation/foundation.topbar.js"></script>
    <link rel="top" title="Haka runtime 0.3.0 documentation" href="../../index.html" />
    <link rel="up" title="Welcome to Haka’s User Reference Guide!" href="refindex.html" />
    <link rel="next" title="10. Grammar" href="grammar.html" />
    <link rel="prev" title="8.3. Disassembler" href="../../modules/misc/asm/doc/asm.html" /> 
  </head>
  <body>


<header id="header" role="banner">
	<div class="row">
		<div class="medium-6 columns">
			<h1 class="title"><a rel="home" title="Haka" href="http://www.haka-security.org">Haka</a></h1>
			<h2 class="description">Software Defined Security</h2>
		</div>
		<div class="medium-6 columns">
			<div id="version">Version 0.3.0</div>
		</div>
	</div>
</header>

<div class="contain-to-grid sticky">
	

<nav id="navbar" class="top-bar" data-topbar>
	<ul class="title-area">
		<!-- This is required for toggle-topbar to work -->
		<li class="name"></li>
		<li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
	</ul>
	<section class="top-bar-section">
		<ul class="left">
			<li class=" ">
				<a href="../user/userindex.html">Users</a>
			</li>
			<li class=" active">
				<a href="refindex.html" class="refindex.html">References</a>
			</li>
			<li class=" ">
				<a href="../developer/devindex.html" class="">Developers</a>
			</li>
			<li class=" ">
				<a href="../faq.html" class="">Faq</a>
			</li>
			<li class="has-form">


	<form class="search" action="../../search.html" method="get" id="searchbox" style="display: none">
		<input type="hidden" name="area" value="default" />
		<input type="hidden" name="check_keywords" value="yes" />
		<div class="row collapse">
			<div class="medium-11 columns">
				<input type="text" name="q" placeholder="Search" />
			</div>
			<div class="medium-1 columns" id="clean-search-highlight">
			</div>
		</div>
	</form>
	<script type="text/javascript">$('#searchbox').show(0);</script>
</li>
		</ul>
		<ul class="right">
				<li class="right"><a href="grammar.html" title="10. Grammar">Next &rarr;</a></li>
				<li class="right"><a href="../../modules/misc/asm/doc/asm.html" title="8.3. Disassembler">&larr; Prev</a></li>
				<li class="right"><a href="refindex.html" title="Welcome to Haka&#8217;s User Reference Guide!">Up &uarr;</a></li>

			<li class=" right"><a href="../../genindex.html">Index</a></li>
			<li class=" right"><a href="../../haka-modindex.html">Modules</a></li>
		</ul>
	</section>
</nav>
</div>
<div id="content">
	<div class="row">
		<ul id="breadcrumb" class="breadcrumbs medium-12 columns">
			
			<li><a href="refindex.html">Welcome to Haka&#8217;s User Reference Guide!</a></li>
			
			<li class="current"><a href="#">9. Rules</a></li>
		</ul>
	</div>
	<div class="row">
		<div class="medium-12 columns">
			
  <div class="section" id="haka-module.haka">
<span id="rules"></span><h1>9. Rules<a class="headerlink" href="#haka-module.haka" title="Permalink to this headline">¶</a></h1>
<div class="section" id="events">
<h2>9.1. Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<p>Haka core will trigger various events emitted by dissectors for instance. This events allow
the user to place rules to verify some property and react if needed.</p>
<p>To get the list of supported events and for each of them their parameters, check the documentation
of the protocol dissectors (<a class="reference internal" href="hakadissector.html"><em>Haka dissectors</em></a>).</p>
</div>
<div class="section" id="single-rule">
<h2>9.2. Single Rule<a class="headerlink" href="#single-rule" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="haka-function.haka.rule">
<em class="property"> </em><tt class="descclassname">haka.</tt><tt class="descname">rule</tt><big>{</big><em>...</em><big>}</big><a class="headerlink" href="#haka-function.haka.rule" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>hook</strong> (<em>Event</em>) &#8211; Event to listen to.</li>
<li><strong>eval</strong> (<em>function</em>) &#8211; Function to call when the event is triggered.</li>
<li><strong>options</strong> (<em>table</em>) &#8211; List of options for the rule.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Register a new rule on the given event.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Options are specific to the events you are hooking to. See <a class="reference internal" href="hakadissector.html"><em>Haka dissectors</em></a> for more information.</p>
</div>
</dd></dl>

<div class="section" id="example">
<h3>9.2.1. Example:<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">------------------------------------</span>
<span class="c1">-- Loading dissectors</span>
<span class="c1">------------------------------------</span>
<span class="kd">local</span> <span class="n">ipv4</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">protocol/ipv4&#39;</span><span class="p">)</span>

<span class="c1">-- drop all packets originating from</span>
<span class="c1">-- blacklisted address 192.168.10.10</span>
<span class="n">haka</span><span class="p">.</span><span class="n">rule</span><span class="p">{</span>
    <span class="c1">-- This rule is applied on each ip incoming packet</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">ipv4</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="n">receive_packet</span><span class="p">,</span>
    <span class="n">eval</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
        <span class="c1">-- Parse the IP address and assign it to a variable</span>
        <span class="kd">local</span> <span class="n">bad_ip</span> <span class="o">=</span> <span class="n">ipv4</span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">192.168.10.10&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pkt</span><span class="p">.</span><span class="n">src</span> <span class="o">==</span> <span class="n">bad_ip</span> <span class="k">then</span>
            <span class="c1">-- Raise an alert</span>
            <span class="n">haka</span><span class="p">.</span><span class="n">alert</span><span class="p">{</span>
                <span class="n">description</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Filtering IP %s&quot;</span><span class="p">,</span> <span class="n">bad_ip</span><span class="p">),</span>
                <span class="n">severity</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">low&#39;</span>
            <span class="p">}</span>
            <span class="c1">-- and drop the packet</span>
            <span class="n">pkt</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
        <span class="k">end</span>
        <span class="c1">-- All other packets will be accepted</span>
    <span class="k">end</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="interactive-rule">
<h2>9.3. Interactive rule<a class="headerlink" href="#interactive-rule" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="haka-function.haka.interactive_rule">
<em class="property"> </em><tt class="descclassname">haka.</tt><tt class="descname">interactive_rule</tt><big>(</big><em>name</em><big>)</big> &rarr; func<a class="headerlink" href="#haka-function.haka.interactive_rule" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>name</strong> (<em>string</em>) &#8211; Rule name displayed in prompt.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><ul class="first last simple">
<li><strong>func</strong> (<em>function</em>) &#8211; Rule function.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Utility function to create an interactive rule. Use this function to build an <em>eval</em> function
of one of your rule.</p>
<p>When the rule is evaluated, a prompt will enable the user to enter some commands. The parameters
given to the rule are available through the table named <em>inputs</em>.</p>
<p><strong>Usage:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">haka</span><span class="p">.</span><span class="n">rule</span><span class="p">{</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">ipv4</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="n">receive_packet</span><span class="p">,</span>
    <span class="n">eval</span> <span class="o">=</span> <span class="n">haka</span><span class="p">.</span><span class="n">interactive_rule</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">interactive&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="rule-group">
<h2>9.4. Rule Group<a class="headerlink" href="#rule-group" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="haka-object.rule_group">
<em class="property">object </em><tt class="descname">rule_group</tt><a class="headerlink" href="#haka-object.rule_group" title="Permalink to this definition">¶</a></dt>
<dd><p>Rule group allows customizing the rule evaluation.</p>
<dl class="function">
<dt id="haka-function.haka.rule_group">
<em class="property"> </em><tt class="descclassname">haka.</tt><tt class="descname">rule_group</tt><big>{</big><em>...</em><big>}</big> &rarr; group<a class="headerlink" href="#haka-function.haka.rule_group" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>hook</strong> (<em>event</em>) &#8211; Event to listen to.</li>
<li><strong>init</strong> (<em>function</em>) &#8211; Function that is called whenever the event is triggered and before any rule evaluation.</li>
<li><strong>continue</strong> (<em>function</em>) &#8211; After each rule evaluation, the function is called to know if the evaluation
of the other rules should continue. If not, the other rules will be skipped.</li>
<li><strong>final</strong> (<em>function</em>) &#8211; If all the rules of the group have been evaluated, this callback is called
at the end.</li>
<li><strong>options</strong> (<em>table</em>) &#8211; List of options for the rule.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><ul class="first last simple">
<li><strong>group</strong> (<a class="reference internal" href="#haka-object.rule_group" title="rule_group"><tt class="xref haka haka-class docutils literal"><span class="pre">rule_group</span></tt></a>) &#8211; New rule group.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Create a new rule group on the given event.</p>
<dl class="function">
<dt>
<em class="property"> </em><tt class="descname">init</tt><big>(</big><em>...</em><big>)</big></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>...</strong> &#8211; Parameter from the event.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><tt class="descname">continue</tt><big>(</big><em>ret</em>, <em>...</em><big>)</big> &rarr; should_continue</dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>ret</strong> &#8211; Result from the previous rule evaluation.</li>
<li><strong>...</strong> &#8211; Parameter from the event.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><ul class="first last simple">
<li><strong>should_continue</strong> (<em>boolean</em>) &#8211; <tt class="docutils literal"><span class="pre">true</span></tt> if the next rule in the group should be evaluated.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><tt class="descname">final</tt><big>(</big><em>...</em><big>)</big></dt>
<dd></dd></dl>

</dd></dl>

<dl class="method">
<dt id="haka-function.&lt;rule_group&gt;.rule">
<em class="property"> </em><tt class="descclassname">&lt;rule_group&gt;:</tt><tt class="descname">rule</tt><big>(</big><em>eval</em><big>)</big><a class="headerlink" href="#haka-function.<rule_group>.rule" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>eval</strong> (<em>function</em>) &#8211; Evaluation function.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Register a rule for this group.</p>
</dd></dl>

</dd></dl>

<div class="section" id="id1">
<h3>9.4.1. Example:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">------------------------------------</span>
<span class="c1">-- Firewall rules</span>
<span class="c1">------------------------------------</span>

<span class="kd">local</span> <span class="n">client_network</span> <span class="o">=</span> <span class="n">ipv4</span><span class="p">.</span><span class="n">network</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">192.168.10.0/25&quot;</span><span class="p">);</span>
<span class="kd">local</span> <span class="n">server_network</span> <span class="o">=</span> <span class="n">ipv4</span><span class="p">.</span><span class="n">network</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">192.168.20.0/25&quot;</span><span class="p">);</span>

<span class="kd">local</span> <span class="n">group</span> <span class="o">=</span> <span class="n">haka</span><span class="p">.</span><span class="n">rule_group</span> <span class="p">{</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">tcp_connection</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="n">new_connection</span><span class="p">,</span>
    <span class="n">init</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span>
        <span class="n">haka</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">entering packet filtering rules : %d --&gt; %d&quot;</span><span class="p">,</span>
            <span class="n">pkt</span><span class="p">.</span><span class="n">srcport</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">dstport</span><span class="p">)</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="n">final</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span>
        <span class="n">haka</span><span class="p">.</span><span class="n">alert</span><span class="p">{</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">Packet dropped : drop by default&quot;</span><span class="p">,</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">haka</span><span class="p">.</span><span class="n">alert</span><span class="p">.</span><span class="n">address</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">srcport</span><span class="p">),</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">haka</span><span class="p">.</span><span class="n">alert</span><span class="p">.</span><span class="n">address</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">dstport</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">pkt</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="n">continue</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">ret</span>
    <span class="k">end</span>
<span class="p">}</span>


<span class="n">group</span><span class="p">:</span><span class="n">rule</span><span class="p">{</span>
    <span class="n">eval</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">tcp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client_network</span><span class="p">:</span><span class="n">contains</span><span class="p">(</span><span class="n">tcp</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">server_network</span><span class="p">:</span><span class="n">contains</span><span class="p">(</span><span class="n">tcp</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">tcp</span><span class="p">.</span><span class="n">dstport</span> <span class="o">==</span> <span class="mi">80</span> <span class="k">then</span>
            <span class="n">haka</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">authorizing http traffic&quot;</span><span class="p">)</span>
            <span class="n">http</span><span class="p">.</span><span class="n">dissect</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="p">}</span>

<span class="n">group</span><span class="p">:</span><span class="n">rule</span><span class="p">{</span>
    <span class="n">eval</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">tcp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client_network</span><span class="p">:</span><span class="n">contains</span><span class="p">(</span><span class="n">tcp</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">server_network</span><span class="p">:</span><span class="n">contains</span><span class="p">(</span><span class="n">tcp</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">tcp</span><span class="p">.</span><span class="n">dstport</span> <span class="o">==</span> <span class="mi">22</span> <span class="k">then</span>
            <span class="n">haka</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">authorizing ssh traffic&quot;</span><span class="p">)</span>
            <span class="n">haka</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">no available dissector for ssh&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


		</div>
	</div>
</div>



<footer id="footer">
	<div class="row" role="complementary">
		<div class="medium-12 columns">
			&copy; Copyright 2014, Arkoon Network Security, OpenWide and Telecom ParisTech.
		</div>
	</div>
</footer>
<script>
	  $(document).foundation();
</script>



<script type="text/javascript" src="http://www.haka-security.org/js/track.js"></script>


  </body>
</html>